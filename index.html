<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æª”æ¡ˆæ¨¹ç‹€æª¢è¦–èˆ‡å‚™è¨» (Pure Web)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            font-family: "Segoe UI", "Microsoft JhengHei", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            color: #111827;
            background-color: #f5f6fb;
        }

        * { box-sizing: border-box; }
        .hidden { display: none !important; }

        body { margin: 0; min-height: 100vh; display: flex; flex-direction: column; }

        header {
            background: linear-gradient(120deg, #1f5eff, #0f172a);
            color: #fff;
            padding: 1.2rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 1rem;
            flex-wrap: wrap;
        }

        header h1 { margin: 0 0 0.25rem; font-size: 1.75rem; }

        .subtitle {
            margin: 0; font-size: 0.95rem; color: rgba(255, 255, 255, 0.85);
            display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;
        }

        .subtitle label, .subtitle button {
            border: none; border-radius: 20px; background: rgba(255, 255, 255, 0.15);
            color: #fff; padding: 0.2rem 0.9rem; font-size: 0.85rem; cursor: pointer; display: inline-block;
        }

        .subtitle label:hover, .subtitle button:hover { background: rgba(255, 255, 255, 0.25); }

        main.layout { flex: 1; display: flex; gap: 1.25rem; padding: 1.25rem 2rem; align-items: stretch; flex-wrap: wrap; }

        .panel {
            background: #fff; border-radius: 14px; box-shadow: 0 15px 35px rgba(15, 23, 42, 0.08);
            padding: 1rem; flex: 1 1 320px; min-height: 400px; display: flex; flex-direction: column;
        }

        .tree-panel { max-width: 520px; }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; gap: 1rem; }
        .panel-header h2 { margin: 0; font-size: 1.1rem; color: #0f172a; }

        #treeContainer { flex: 1; overflow: auto; padding-right: 0.25rem; }

        .tree { list-style: none; padding-inline-start: 0.75rem; margin: 0; }
        .tree ul { list-style: none; padding-left: 1.1rem; margin: 0.15rem 0 0.25rem; }
        .tree-node { margin-bottom: 0.35rem; }

        .tree-row {
            display: flex; align-items: center; gap: 0.35rem; border-radius: 10px;
            padding: 0.3rem 0.55rem; cursor: pointer; transition: background 0.2s, box-shadow 0.2s;
        }
        .tree-row:hover { background: rgba(37, 99, 235, 0.08); }
        .tree-row.selected { background: rgba(59, 130, 246, 0.15); box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.3); }

        .tree-row.has-note::after {
            content: "å‚™è¨»"; font-size: 0.7rem; background: #fde047; color: #7c2d12;
            padding: 0.1rem 0.35rem; border-radius: 999px; margin-left: auto;
        }

        .tree-label { font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .tree-icon {
            width: 1.7rem; height: 1.35rem; display: inline-flex; align-items: center; justify-content: center;
            background-repeat: no-repeat; background-position: center; background-size: contain; margin-right: 0.15rem;
        }

        .icon-folder { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none'%3E%3Cpath d='M3 7.5h6.2c.5 0 .9.3 1.1.7l.5 1c.2.5.6.8 1.1.8H21c.6 0 1 .4 1 1v6.5c0 .8-.7 1.5-1.5 1.5h-17C2.7 19 2 18.3 2 17.5v-9C2 7.8 2.4 7.5 3 7.5Z' fill='%23facc15' stroke='%23d97706' stroke-width='1.5'/%3E%3Cpath d='M3 8.8h18' stroke='%23d97706' stroke-width='1.2'/%3E%3C/svg%3E"); }
        .icon-file-default { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none'%3E%3Cpath d='M6 3h7l5 5v12.5c0 .8-.7 1.5-1.5 1.5h-10C5.7 22 5 21.3 5 20.5v-16C5 3.7 5.7 3 6.5 3Z' fill='%23c7d2fe' stroke='%234f46e5' stroke-width='1.4'/%3E%3Cpath d='M13 3v5h5' stroke='%234f46e5' stroke-width='1.2'/%3E%3C/svg%3E"); }

        .tree-toggle { border: none; background: transparent; color: #1d4ed8; cursor: pointer; font-size: 0.85rem; width: 1.5rem; }
        .tree-node.collapsed > ul { display: none; }

        .detail-panel { flex: 2 1 360px; }
        .placeholder { margin: 2rem 0; color: #94a3b8; text-align: center; }
        .detail-grid { display: flex; flex-direction: column; gap: 1rem; }
        .detail-row { display: flex; gap: 0.5rem; align-items: baseline; }
        .label { width: 90px; font-weight: 600; color: #475569; }
        .code { font-family: "Consolas", monospace; background: #f1f5f9; padding: 0.1rem 0.35rem; border-radius: 6px; word-break: break-all; }

        textarea {
            resize: vertical; border-radius: 10px; border: 1px solid #cbd5f5;
            padding: 0.65rem; font-size: 1rem; font-family: inherit; background: #f8fafc;
            min-height: 200px; transition: border 0.2s, background 0.2s;
        }
        textarea:focus { border-color: #2563eb; outline: none; background: #fff; }

        button.primary { background: #2563eb; color: #fff; border-radius: 999px; border: 1px solid #2563eb; padding: 0.35rem 1.1rem; font-size: 0.9rem; cursor: pointer; }

        /* PDF è¼¸å‡ºå°ˆç”¨æ¨£å¼ */
        .pdf-report { background: white; padding: 20px; color: black; width: 800px; }
        .pdf-title { border-bottom: 2px solid #1f5eff; padding-bottom: 10px; font-size: 24px; margin-bottom: 20px; }
        .pdf-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        /* é—œéµï¼šé˜²æ­¢åˆ†é è£åˆ‡ */
        .pdf-table tr { page-break-inside: avoid !important; break-inside: avoid !important; }
        
        .pdf-table td { padding: 0; vertical-align: stretch; border-bottom: 1px solid #f0f0f0; }
        .pdf-col-tree { width: 65%; display: flex; align-items: stretch; }
        .pdf-col-note { width: 35%; padding: 4px 8px; vertical-align: middle; }
        
        .pdf-gutter { display: flex; height: auto; }
        .pdf-indent-unit { width: 20px; display: flex; justify-content: center; position: relative; }
        .pdf-v-line { position: absolute; top: 0; bottom: 0; width: 1px; background: #ccc; left: 50%; }
        .pdf-h-line { position: absolute; top: 50%; width: 10px; height: 1px; background: #ccc; left: 50%; }
        .pdf-l-corner { position: absolute; top: 0; bottom: 50%; width: 1px; background: #ccc; left: 50%; }
        
        .pdf-node-content { display: flex; align-items: center; padding: 8px 4px; gap: 6px; flex: 1; font-size: 11px; }
        .pdf-note-box { 
            background: #fffbe6; border: 1px solid #ffe58f; padding: 6px 10px; border-radius: 4px; 
            font-size: 11px; color: #854d0e; word-break: break-all; width: 100%; box-sizing: border-box;
            line-height: 1.4;
        }

        input[type="file"] { display: none; }
        footer { padding: 0.75rem 2rem 1.25rem; font-size: 0.9rem; color: #475569; }
    </style>
</head>
<body>
    <header>
      <div>
        <h1>æª”æ¡ˆæ¨¹ç‹€æª¢è¦–èˆ‡å‚™è¨»</h1>
        <p class="subtitle">
          ç›®å‰ç›®éŒ„ï¼š<span id="rootPathLabel">æœªé¸æ“‡</span>
          <label for="dirInput">é¸æ“‡ç›®éŒ„</label>
          <input type="file" id="dirInput" webkitdirectory directory />
        </p>
      </div>
      <button id="exportPdf" type="button" class="primary">è¼¸å‡º PDF</button>
    </header>

    <main class="layout">
      <section class="panel tree-panel">
        <div class="panel-header"><h2>è³‡æ–™å¤¾æ¨¹ç‹€</h2><span id="statusMessage"></span></div>
        <div id="treeContainer">
          <ul id="treeRoot" class="tree"></ul>
        </div>
      </section>
      <section class="panel detail-panel">
        <div class="panel-header"><h2>å‚™è¨»ç·¨è¼¯</h2></div>
        <div id="detailBody">
          <p class="placeholder">è«‹å…ˆåœ¨å·¦å´é¸æ“‡æª”æ¡ˆæˆ–è³‡æ–™å¤¾ã€‚</p>
          <div class="detail-grid hidden" id="detailGrid">
            <div class="detail-row"><span class="label">åç¨±</span><span id="detailName"></span></div>
            <div class="detail-row"><span class="label">ç›¸å°è·¯å¾‘</span><span id="detailPath" class="code"></span></div>
            <label for="noteInput">å‚™è¨»å…§å®¹</label>
            <textarea id="noteInput" rows="8" placeholder="åœ¨æ­¤è¼¸å…¥è¨»è§£ï¼Œé›¢é–‹å³è‡ªå‹•å„²å­˜ã€‚"></textarea>
          </div>
        </div>
      </section>
    </main>

    <div id="pdf-export-container" style="display:none;">
        <div id="pdf-report" class="pdf-report">
            <h1 class="pdf-title">æª”æ¡ˆæ¨¹ç‹€çµæ§‹å ±å‘Š</h1>
            <p style="font-size: 12px;">æ ¹ç›®éŒ„ï¼š<span id="pdf-root"></span></p>
            <p style="font-size: 12px; color: #666; margin-bottom: 20px;">ç”Ÿæˆæ™‚é–“ï¼š<span id="pdf-date"></span></p>
            <table class="pdf-table">
                <tbody id="pdf-rows"></tbody>
            </table>
        </div>
    </div>

    <script>
        const treeRoot = document.getElementById('treeRoot');
        const dirInput = document.getElementById('dirInput');
        const rootPathLabel = document.getElementById('rootPathLabel');
        const detailGrid = document.getElementById('detailGrid');
        const detailBody = document.getElementById('detailBody');
        const noteInput = document.getElementById('noteInput');
        
        let fileStructure = null;
        let selectedNode = null;
        let notes = JSON.parse(localStorage.getItem('pure-web-tree-notes') || '{}');

        dirInput.onchange = (e) => {
            const files = e.target.files;
            if (!files.length) return;
            const rootName = files[0].webkitRelativePath.split('/')[0];
            rootPathLabel.innerText = rootName;
            buildTree(files, rootName);
            renderTree();
            document.querySelector('.placeholder').classList.add('hidden');
        };

        function buildTree(files, rootName) {
            fileStructure = { name: rootName, type: 'directory', children: [], path: rootName };
            for (let i = 0; i < files.length; i++) {
                const pathParts = files[i].webkitRelativePath.split('/');
                let current = fileStructure;
                let currentPath = rootName;
                for (let j = 1; j < pathParts.length; j++) {
                    const name = pathParts[j];
                    currentPath += "/" + name;
                    let node = current.children.find(c => c.name === name);
                    if (!node) {
                        node = { name, type: j === pathParts.length - 1 ? 'file' : 'directory', children: [], path: currentPath };
                        current.children.push(node);
                    }
                    current = node;
                }
            }
            const sort = (n) => { if (n.children) { n.children.sort((a,b) => b.type.localeCompare(a.type) || a.name.localeCompare(b.name)); n.children.forEach(sort); } };
            sort(fileStructure);
        }

        function renderTree() {
            treeRoot.innerHTML = '';
            treeRoot.appendChild(createNodeEl(fileStructure));
        }

        function createNodeEl(node) {
            const li = document.createElement('li');
            li.className = 'tree-node';
            const row = document.createElement('div');
            row.className = 'tree-row';
            if (notes[node.path]) row.classList.add('has-note');
            const toggle = document.createElement('button');
            toggle.className = 'tree-toggle';
            toggle.innerText = node.type === 'directory' ? 'v' : ' ';
            if (node.type === 'directory') {
                toggle.onclick = (e) => { e.stopPropagation(); li.classList.toggle('collapsed'); toggle.innerText = li.classList.contains('collapsed') ? '>' : 'v'; };
            }
            row.appendChild(toggle);
            const icon = document.createElement('span');
            icon.className = 'tree-icon ' + (node.type === 'directory' ? 'icon-folder' : 'icon-file-default');
            row.appendChild(icon);
            const label = document.createElement('span');
            label.className = 'tree-label';
            label.innerText = node.name;
            row.appendChild(label);
            row.onclick = () => { document.querySelectorAll('.tree-row').forEach(r => r.classList.remove('selected')); row.classList.add('selected'); showDetail(node, row); };
            li.appendChild(row);
            if (node.children) { const ul = document.createElement('ul'); node.children.forEach(c => ul.appendChild(createNodeEl(c))); li.appendChild(ul); }
            return li;
        }

        function showDetail(node, rowEl) {
            saveCurrentNote();
            selectedNode = { node, el: rowEl };
            detailGrid.classList.remove('hidden');
            document.getElementById('detailName').innerText = node.name;
            document.getElementById('detailPath').innerText = node.path;
            noteInput.value = notes[node.path] || '';
        }

        function saveCurrentNote() {
            if (selectedNode) {
                const val = noteInput.value.trim();
                if (val) { notes[selectedNode.node.path] = val; selectedNode.el.classList.add('has-note'); }
                else { delete notes[selectedNode.node.path]; selectedNode.el.classList.remove('has-note'); }
                localStorage.setItem('pure-web-tree-notes', JSON.stringify(notes));
            }
        }

        noteInput.onblur = saveCurrentNote;

        document.getElementById('exportPdf').onclick = () => {
            if (!fileStructure) return alert("è«‹å…ˆé¸æ“‡è³‡æ–™å¤¾ï¼");
            saveCurrentNote();
            
            const rowsContainer = document.getElementById('pdf-rows');
            rowsContainer.innerHTML = '';
            document.getElementById('pdf-date').innerText = new Date().toLocaleString();
            document.getElementById('pdf-root').innerText = rootPathLabel.innerText;

            const process = (node, depth, isLast, prefixes) => {
                const tr = document.createElement('tr');
                const tdTree = document.createElement('td');
                tdTree.className = 'pdf-col-tree';
                const gutter = document.createElement('div');
                gutter.className = 'pdf-gutter';
                prefixes.forEach((p, idx) => {
                    const unit = document.createElement('div');
                    unit.className = 'pdf-indent-unit';
                    if (idx < prefixes.length - 1 && p) {
                        const line = document.createElement('div');
                        line.className = 'pdf-v-line';
                        unit.appendChild(line);
                    } else if (idx === prefixes.length - 1) {
                        const line = document.createElement('div');
                        line.className = isLast ? 'pdf-l-corner' : 'pdf-v-line';
                        unit.appendChild(line);
                        const hLine = document.createElement('div');
                        hLine.className = 'pdf-h-line';
                        unit.appendChild(hLine);
                    }
                    gutter.appendChild(unit);
                });
                const content = document.createElement('div');
                content.className = 'pdf-node-content';
                content.innerHTML = `<span>${node.type === 'directory' ? 'ğŸ“' : 'ğŸ“„'}</span><span style="${node.type === 'directory' ? 'font-weight:bold' : ''}">${node.name}</span>`;
                tdTree.appendChild(gutter);
                tdTree.appendChild(content);
                tr.appendChild(tdTree);

                const tdNote = document.createElement('td');
                tdNote.className = 'pdf-col-note';
                if (notes[node.path]) {
                    const noteBox = document.createElement('div');
                    noteBox.className = 'pdf-note-box';
                    noteBox.innerText = notes[node.path];
                    tdNote.appendChild(noteBox);
                }
                tr.appendChild(tdNote);
                rowsContainer.appendChild(tr);

                if (node.children) {
                    node.children.forEach((c, idx) => {
                        const last = idx === node.children.length - 1;
                        process(c, depth + 1, last, [...prefixes, !last]);
                    });
                }
            };

            process(fileStructure, 0, true, []);
            
            const element = document.getElementById('pdf-report');
            const opt = {
                margin: 10,
                filename: 'file-tree-report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'legacy'] }
            };
            html2pdf().set(opt).from(element).save();
        };
    </script>
</body>
</html>
