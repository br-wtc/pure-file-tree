<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>檔案樹狀檢視與備註 (Pure Web)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            font-family: "Segoe UI", "Microsoft JhengHei", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            color: #111827;
            background-color: #f5f6fb;
        }

        * { box-sizing: border-box; }
        .hidden { display: none !important; }

        body { margin: 0; min-height: 100vh; display: flex; flex-direction: column; }

        header {
            background: linear-gradient(120deg, #1f5eff, #0f172a);
            color: #fff;
            padding: 1.2rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 1rem;
            flex-wrap: wrap;
        }

        header h1 { margin: 0 0 0.25rem; font-size: 1.75rem; }

        .subtitle {
            margin: 0; font-size: 0.95rem; color: rgba(255, 255, 255, 0.85);
            display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;
        }

        .subtitle label, .subtitle button {
            border: none; border-radius: 20px; background: rgba(255, 255, 255, 0.15);
            color: #fff; padding: 0.2rem 0.9rem; font-size: 0.85rem; cursor: pointer; display: inline-block;
        }

        .subtitle label:hover, .subtitle button:hover { background: rgba(255, 255, 255, 0.25); }

        main.layout { flex: 1; display: flex; gap: 1.25rem; padding: 1.25rem 2rem; align-items: stretch; flex-wrap: wrap; }

        .panel {
            background: #fff; border-radius: 14px; box-shadow: 0 15px 35px rgba(15, 23, 42, 0.08);
            padding: 1rem; flex: 1 1 320px; min-height: 400px; display: flex; flex-direction: column;
        }

        .tree-panel { max-width: 520px; }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; gap: 1rem; }
        .panel-header h2 { margin: 0; font-size: 1.1rem; color: #0f172a; }
        .panel-actions { display: flex; align-items: center; gap: 0.85rem; flex-wrap: wrap; }

        #statusMessage { min-height: 1.25rem; font-size: 0.9rem; color: #2563eb; }
        #statusMessage[data-state="error"] { color: #dc2626; }
        #statusMessage[data-state="success"] { color: #16a34a; }

        #treeContainer { flex: 1; overflow: auto; padding-right: 0.25rem; }

        .tree { list-style: none; padding-inline-start: 0.75rem; margin: 0; }
        .tree ul { list-style: none; padding-left: 1.1rem; margin: 0.15rem 0 0.25rem; }
        .tree-node { margin-bottom: 0.35rem; }

        .tree-row {
            display: flex; align-items: center; gap: 0.35rem; border-radius: 10px;
            padding: 0.3rem 0.55rem; cursor: pointer; transition: background 0.2s, box-shadow 0.2s;
        }
        .tree-row:hover { background: rgba(37, 99, 235, 0.08); }
        .tree-row.selected { background: rgba(59, 130, 246, 0.15); box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.3); }

        .tree-row.has-note::after {
            content: "備註"; font-size: 0.7rem; background: #fde047; color: #7c2d12;
            padding: 0.1rem 0.35rem; border-radius: 999px; margin-left: auto;
        }

        .tree-label { font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .tree-icon {
            width: 1.7rem; height: 1.35rem; display: inline-flex; align-items: center; justify-content: center;
            background-repeat: no-repeat; background-position: center; background-size: contain; margin-right: 0.15rem;
        }

        .tree-icon.icon-folder { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none'%3E%3Cpath d='M3 7.5h6.2c.5 0 .9.3 1.1.7l.5 1c.2.5.6.8 1.1.8H21c.6 0 1 .4 1 1v6.5c0 .8-.7 1.5-1.5 1.5h-17C2.7 19 2 18.3 2 17.5v-9C2 7.8 2.4 7.5 3 7.5Z' fill='%23facc15' stroke='%23d97706' stroke-width='1.5'/%3E%3Cpath d='M3 8.8h18' stroke='%23d97706' stroke-width='1.2'/%3E%3C/svg%3E"); }
        .tree-icon.icon-file-default { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none'%3E%3Cpath d='M6 3h7l5 5v12.5c0 .8-.7 1.5-1.5 1.5h-10C5.7 22 5 21.3 5 20.5v-16C5 3.7 5.7 3 6.5 3Z' fill='%23c7d2fe' stroke='%234f46e5' stroke-width='1.4'/%3E%3Cpath d='M13 3v5h5' stroke='%234f46e5' stroke-width='1.2'/%3E%3C/svg%3E"); }

        .tree-toggle { border: none; background: transparent; color: #1d4ed8; cursor: pointer; font-size: 0.85rem; width: 1.5rem; }
        .tree-node.collapsed > ul { display: none; }

        .detail-panel { flex: 2 1 360px; }
        .placeholder { margin: 2rem 0; color: #94a3b8; text-align: center; }
        .detail-grid { display: flex; flex-direction: column; gap: 1rem; }
        .detail-row { display: flex; gap: 0.5rem; align-items: baseline; }
        .label { width: 90px; font-weight: 600; color: #475569; }
        .code { font-family: "Consolas", monospace; background: #f1f5f9; padding: 0.1rem 0.35rem; border-radius: 6px; word-break: break-all; }

        form#noteForm { display: flex; flex-direction: column; gap: 0.5rem; }

        textarea {
            resize: vertical; border-radius: 10px; border: 1px solid #cbd5f5;
            padding: 0.65rem; font-size: 1rem; font-family: inherit; background: #f8fafc;
            min-height: 160px; transition: border 0.2s, background 0.2s;
        }
        textarea:focus { border-color: #2563eb; outline: none; background: #fff; }

        .form-actions { display: flex; justify-content: flex-end; }
        button { border-radius: 999px; border: 1px solid #cbd5f5; background: #fff; padding: 0.35rem 1.1rem; font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
        button.primary { background: #2563eb; color: #fff; border-color: #2563eb; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button:not(:disabled):hover { background: rgba(37, 99, 235, 0.08); }
        button.primary:not(:disabled):hover { background: #1d4ed8; }

        footer { padding: 0.75rem 2rem 1.25rem; font-size: 0.9rem; color: #475569; }

        input[type="file"] { display: none; }

        @media (max-width: 900px) {
            main.layout { flex-direction: column; }
            .tree-panel { max-width: none; }
            header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <header>
      <div>
        <h1>檔案樹狀檢視與備註</h1>
        <p class="subtitle">
          目前目錄：<span id="rootPathLabel">未選擇</span>
          <label for="dirInput">選擇目錄</label>
          <input type="file" id="dirInput" webkitdirectory directory />
        </p>
      </div>
      <button id="exportPdf" type="button" class="primary">
        輸出 PDF
      </button>
    </header>

    <main class="layout">
      <section class="panel tree-panel">
        <div class="panel-header">
          <h2>資料夾樹狀</h2>
          <div class="panel-actions">
            <span id="statusMessage" aria-live="polite"></span>
          </div>
        </div>
        <div id="treeContainer">
          <ul id="treeRoot" class="tree"></ul>
        </div>
      </section>

      <section class="panel detail-panel">
        <div class="panel-header">
          <h2>備註編輯</h2>
        </div>
        <div id="detailBody">
          <p class="placeholder">請先在左側選擇檔案或資料夾。</p>
          <div class="detail-grid hidden" id="detailGrid">
            <div class="detail-row">
              <span class="label">名稱</span>
              <span id="detailName"></span>
            </div>
            <div class="detail-row">
              <span class="label">相對路徑</span>
              <span id="detailPath" class="code"></span>
            </div>
            <form id="noteForm">
              <label for="noteInput">備註內容</label>
              <textarea
                id="noteInput"
                name="note"
                rows="8"
                placeholder="在此輸入註解，離開即自動儲存。"
              ></textarea>
            </form>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <p>
        說明：此工具純網頁運行，使用 LocalStorage 儲存備註，支援匯出 PDF（含備註）。
      </p>
    </footer>

    <script>
        const treeRoot = document.getElementById('treeRoot');
        const dirInput = document.getElementById('dirInput');
        const rootPathLabel = document.getElementById('rootPathLabel');
        const detailGrid = document.getElementById('detailGrid');
        const detailBody = document.getElementById('detailBody');
        const noteInput = document.getElementById('noteInput');
        const statusEl = document.getElementById('statusMessage');
        
        let fileStructure = null;
        let selectedNode = null;
        let notes = JSON.parse(localStorage.getItem('pure-web-tree-notes') || '{}');

        function setStatus(msg, type = 'info') {
            statusEl.textContent = msg;
            statusEl.setAttribute('data-state', type);
            setTimeout(() => { statusEl.textContent = ''; }, 3000);
        }

        dirInput.onchange = (e) => {
            const files = e.target.files;
            if (!files.length) return;
            const rootName = files[0].webkitRelativePath.split('/')[0];
            rootPathLabel.innerText = rootName;
            buildTree(files, rootName);
            renderTree();
            document.querySelector('.placeholder').classList.add('hidden');
            setStatus("檔案載入成功", "success");
        };

        function buildTree(files, rootName) {
            fileStructure = { name: rootName, type: 'directory', children: [], path: rootName };
            for (let i = 0; i < files.length; i++) {
                const pathParts = files[i].webkitRelativePath.split('/');
                let current = fileStructure;
                let currentPath = rootName;
                
                for (let j = 1; j < pathParts.length; j++) {
                    const name = pathParts[j];
                    currentPath += "/" + name;
                    let node = current.children.find(c => c.name === name);
                    if (!node) {
                        node = { 
                            name, 
                            type: j === pathParts.length - 1 ? 'file' : 'directory', 
                            children: [], 
                            path: currentPath 
                        };
                        current.children.push(node);
                    }
                    current = node;
                }
            }
            const sortNodes = (node) => {
                if (node.children) {
                    node.children.sort((a, b) => b.type.localeCompare(a.type) || a.name.localeCompare(b.name));
                    node.children.forEach(sortNodes);
                }
            };
            sortNodes(fileStructure);
        }

        function renderTree() {
            treeRoot.innerHTML = '';
            treeRoot.appendChild(createNodeEl(fileStructure));
        }

        function createNodeEl(node) {
            const li = document.createElement('li');
            li.className = 'tree-node';

            const row = document.createElement('div');
            row.className = 'tree-row';
            if (notes[node.path]) row.classList.add('has-note');
            
            const toggle = document.createElement('button');
            toggle.className = 'tree-toggle';
            toggle.innerText = node.type === 'directory' ? 'v' : ' ';
            if (node.type === 'directory') {
                toggle.onclick = (e) => {
                    e.stopPropagation();
                    li.classList.toggle('collapsed');
                    toggle.innerText = li.classList.contains('collapsed') ? '>' : 'v';
                };
            }
            row.appendChild(toggle);

            const icon = document.createElement('span');
            icon.className = 'tree-icon ' + (node.type === 'directory' ? 'icon-folder' : 'icon-file-default');
            row.appendChild(icon);

            const label = document.createElement('span');
            label.className = 'tree-label';
            label.innerText = node.name;
            row.appendChild(label);

            row.onclick = () => {
                document.querySelectorAll('.tree-row').forEach(r => r.classList.remove('selected'));
                row.classList.add('selected');
                showDetail(node, row);
            };

            li.appendChild(row);
            if (node.children && node.children.length) {
                const ul = document.createElement('ul');
                node.children.forEach(c => ul.appendChild(createNodeEl(c)));
                li.appendChild(ul);
            }
            return li;
        }

        function showDetail(node, rowEl) {
            saveCurrentNote();
            selectedNode = { node, el: rowEl };
            detailGrid.classList.remove('hidden');
            document.getElementById('detailName').innerText = node.name;
            document.getElementById('detailPath').innerText = node.path;
            noteInput.value = notes[node.path] || '';
        }

        function saveCurrentNote() {
            if (selectedNode) {
                const val = noteInput.value.trim();
                if (val) {
                    notes[selectedNode.node.path] = val;
                    selectedNode.el.classList.add('has-note');
                } else {
                    delete notes[selectedNode.node.path];
                    selectedNode.el.classList.remove('has-note');
                }
                localStorage.setItem('pure-web-tree-notes', JSON.stringify(notes));
            }
        }

        noteInput.onblur = saveCurrentNote;

        document.getElementById('exportPdf').onclick = () => {
            if (!fileStructure) return alert("請先選擇資料夾！");
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text("檔案樹狀結構報告", 20, 20);
            
            let y = 30;
            const printNode = (node, depth) => {
                if (y > 280) { doc.addPage(); y = 20; }
                const indent = "  ".repeat(depth);
                const note = notes[node.path] ? ` [備註: ${notes[node.path]}]` : "";
                doc.setFontSize(10);
                doc.text(`${indent}${node.type === 'directory' ? '+' : '-'} ${node.name}${note}`, 20, y);
                y += 7;
                if (node.children) node.children.forEach(c => printNode(c, depth + 1));
            };
            
            printNode(fileStructure, 0);
            doc.save("file-tree-report.pdf");
            setStatus("PDF 下載成功", "success");
        };
    </script>
</body>
</html>
